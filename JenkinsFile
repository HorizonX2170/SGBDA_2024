pipeline {
    agent any
    stages {
        stage('Run PowerShell Script') {
            steps {
                script {
                    echo 'Running PowerShell script'
                    powershell '''
                    $users = Get-ADUser -Filter * -Properties *
                    $blocked_users = $users | Where-Object { $_.accountlockouttime -ge (Get-Date).AddMinutes(-1440)} | Select-Object Name, AccountLockoutTime

                    if ($blocked_users) {
                        $output = "Role;Server;Level;Message;Sender;Description;" + [Environment]::NewLine +
                                  "SMS;Win1;0;Blocker: $($blocked_users.Name -join ', ');SMS;Information about blocked domain users;"
                    } else {
                        $output = ""
                    }

                    $output | Set-Content -Path "C:\\jenkins\\sendsms_blocker24h.txt" -Encoding UTF8
                    '''
                }
            }
        }
        stage('Verify Output') {
            steps {
                script {
                    echo 'Verifying output file'
                    bat 'type C:\\jenkins\\sendsms_blocker24h.txt'
                }
            }
        }
    }
}
